import { useState } from "react";

export default function Home() {
  const [addresses, setAddresses] = useState("");
  const [results, setResults] = useState([]);

  async function handleFetch() {
    // 将用户输入的文本行分割为数组
    const addressList = addresses
      .split("\n")
      .map((line) => line.trim())
      .filter(Boolean);

    if (addressList.length === 0) {
      alert("请先输入地址！");
      return;
    }

    const allResults = [];

    for (const addr of addressList) {
      try {
        // 调用我们自己的后端API而不是第三方
        // 这里假设你的 API 路由叫 /api/polymarketProxy
        const res = await fetch(`/api/polymarketProxy?address=${addr}`);
        const data = await res.json();
        allResults.push(data);
      } catch (error) {
        console.error("查询失败：", error);
        allResults.push({ address: addr, error: "查询失败" });
      }
    }

    setResults(allResults);
  }

  return (
    <div style={{ padding: 20 }}>
      <h1>批量查询示例 (Next.js + Vercel)</h1>
      <p>每行输入一个地址，然后点击查询：</p>
      <textarea
        style={{ width: 300, height: 120 }}
        value={addresses}
        onChange={(e) => setAddresses(e.target.value)}
      />
      <br />
      <button onClick={handleFetch}>查询</button>

      <table
        style={{
          marginTop: 20,
          width: "100%",
          borderCollapse: "collapse",
          border: "1px solid #ccc",
        }}
      >
        <thead>
          <tr style={{ background: "#f8f8f8" }}>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>地址</th>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>交易次数</th>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>活跃天数</th>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>排名百分比</th>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>最后活跃时间</th>
            <th style={{ border: "1px solid #ccc", padding: "8px" }}>距离今天</th>
          </tr>
        </thead>
        <tbody>
          {results.map((item, i) => {
            return (
              <tr key={i}>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>{item.address}</td>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>
                  {item.transaction_count ?? "N/A"}
                </td>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>
                  {item.active_days ?? "N/A"}
                </td>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>
                  {item.top_percent !== undefined
                    ? item.top_percent.toFixed(4) + "%"
                    : "N/A"}
                </td>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>
                  {item.last_use || "N/A"}
                </td>
                <td style={{ border: "1px solid #ccc", padding: "8px" }}>
                  {item.days_ago || ""}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}
